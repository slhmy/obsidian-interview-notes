---
tags:
  - 计算机网络/传输层
---
需要掌握三次握手和四次挥手的原因，
这里其实说的是连接建立和释放中，一些关键的报文/状态的作用是什么。

## 三次握手

![[TCP 三次握手.png|512]]

关键的是第三次客户端发送的连接确认报文，它的主要作用是避免连接由失效的请求打开。

客户端可能会因为各种网络原因，而收不到服务器的同意连接的请求。
这时客户端可能会重新发起一次连接请求，
如果没有第三条确认的报文，服务器就会因此开启两个连接（但实际上第一个连接是无效的）。

## 四次挥手

![[TCP 四次挥手.jpg|512]]

四次挥手过程中，重要的是 CLOSE-WAIT 和 TIME-WAIT 这两个状态，
它们分别对客户端和服务器有着重要的意义。

CLOSE-WAIT 是服务器在收到客户端 FIN 报文之后进入的状态，
这个状态是为了让服务器端发送还未传送完毕的数据，
传送完毕之后，服务器会发送 FIN 连接释放报文。

TIME-WAIT 是客户端在发送断连 ACK 之后，在 CLOSED 之前进入的一个状态，
持续 2 MSL（最大报文存活时间）。这么做的原因有两个：

- 保证断连 ACK 被服务器接收，如果服务器没有收到断连 ACK，
  在 TIME-WAIT 期间，服务器可以重发 FIN 报文，让客户端重新发送 ACK 报文。
- 让本连接持续时间内所产生的所有报文都从网络中消失，
  使得下一个新的连接不会出现旧的连接请求报文。
